name: Post-Deploy Health Check

on:
  push:
    branches: [main]

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Wait for Railway deploy
        run: sleep 90
        
      - name: Check API health
        run: |
          echo "Checking pb.kandedash.com health..."
          
          # Check main page
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://pb.kandedash.com/)
          if [ "$STATUS" != "200" ]; then
            echo "❌ Main page returned $STATUS"
            exit 1
          fi
          echo "✅ Main page OK"
          
          # Check inbox API
          INBOX=$(curl -s https://pb.kandedash.com/api/inbox)
          
          if echo "$INBOX" | grep -q '"error"'; then
            echo "❌ Inbox API error"
            exit 1
          fi
          echo "✅ Inbox API OK"
          
          # Check if inbox has emails - if empty, restore from backup
          COUNT=$(echo "$INBOX" | grep -o '"id"' | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "⚠️ Inbox empty - restoring drafts..."
            curl -s -X POST "https://pb.kandedash.com/api/inbox/refresh" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.PB_ADMIN_TOKEN }}" \
              -d @data/inbox-backup.json
            echo "✅ Drafts restored"
          else
            echo "✅ Inbox has $COUNT emails"
          fi
          
      - name: Notify on failure
        if: failure()
        run: echo "::error::Health check failed! Check pb.kandedash.com"
