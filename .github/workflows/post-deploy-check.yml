name: Post-Deploy Health Check

on:
  push:
    branches: [main]

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Wait for Railway deploy
        run: sleep 90
        
      - name: Check API health
        run: |
          echo "Checking pb.kandedash.com health..."
          
          # Check main page
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://pb.kandedash.com/)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Main page returned $STATUS"
            exit 1
          fi
          echo "‚úÖ Main page OK"
          
          # Check inbox API
          INBOX=$(curl -s https://pb.kandedash.com/api/inbox)
          
          if echo "$INBOX" | grep -q '"error"'; then
            echo "‚ùå Inbox API error"
            exit 1
          fi
          echo "‚úÖ Inbox API OK"
          
          # Check if inbox has emails - if empty, restore from backup
          COUNT=$(echo "$INBOX" | grep -o '"id"' | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è Inbox empty - restoring drafts..."
            curl -s -X POST "https://pb.kandedash.com/api/inbox/refresh" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.PB_ADMIN_TOKEN }}" \
              -d @data/inbox-backup.json
            echo "‚úÖ Drafts restored"
          else
            echo "‚úÖ Inbox has $COUNT emails"
          fi
          
      - name: Alert on failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d '{"chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}", "text": "üö® pb.kandedash.com health check FAILED after deploy. Check GitHub Actions for details."}'
          
      - name: Alert on success
        if: success()
        run: |
          INBOX=$(curl -s https://pb.kandedash.com/api/inbox)
          COUNT=$(echo "$INBOX" | grep -o '"id"' | wc -l)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"‚úÖ pb.kandedash.com deployed & verified. Inbox: $COUNT emails.\"}"
